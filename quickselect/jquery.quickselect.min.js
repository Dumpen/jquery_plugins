function object(obj){var s=function(){};s.prototype=obj;return new s();}
(function($){var QuickSelect=function($input_element,options){$input_element=$($input_element);var self=this;var AllItems={indexed:{}};var clickedLI=true;var activeSelection=-1;var hasFocus=false;var last_keyCode;var previous_value;var timeout;var ie_stupidity=false;if(/MSIE (\d+\.\d+);/.test(navigator.userAgent)){var ieversion=Number(RegExp.$1);if(ieversion<=7){ie_stupidity=true;}}
var results_list=$('<div class="'+options.resultsClass+'" style="display:block;position:absolute"></div>').hide();var results_mask=$('<iframe />');results_mask.css({border:'none',position:'absolute'});if(options.width>0){results_list.css("width",options.width);results_mask.css("width",options.width);}
$('body').append(results_list);if(ie_stupidity){$('body').append(results_mask);}
var getLabel=function(item){return item.label||(typeof(item)==='string'?item:item[0])||'';};var getValues=function(item){return item.values||(item.value?[item.value]:(typeof(item)==='string'?[item]:item))||[];};var matchers={quicksilver:function(q,data){q=q.toLowerCase();console.log("matching '"+q+"' via quicksilver");console.log(data);AllItems.indexed[q]=[];for(var i in data){var label=getLabel(data[i]).toLowerCase();if(label.score(q)>0){AllItems.indexed[q].push(data[i]);}}
return AllItems.indexed[q].sort(function(a,b){a=getLabel(a);b=getLabel(b);var as=a.toLowerCase().score(q);var bs=b.toLowerCase().score(q);return(as>bs?-1:(bs>as?1:0));});},contains:function(q,data){q=q.toLowerCase();console.log("matching '"+q+"' via contains");console.log(data);AllItems.indexed[q]=[];for(var i in data){var label=getLabel(data[i]).toLowerCase();if(label.indexOf(q)>-1){AllItems.indexed[q].push(data[i]);}}
return AllItems.indexed[q].sort(function(a,b){a=getLabel(a).toLowerCase();b=getLabel(b).toLowerCase();return(a.indexOf(q)>b.indexOf(q)?-1:(a.indexOf(q)<b.indexOf(q)?1:(a>b?-1:(b>a?1:0))));});},startsWith:function(q,data){q=q.toLowerCase();console.log("matching '"+q+"' via startsWith");console.log(data);AllItems.indexed[q]=[];for(var i in data){var label=getLabel(data[i]).toLowerCase();if(label.indexOf(q)===0){AllItems.indexed[q].push(data[i]);}}
return AllItems.indexed[q].sort(function(a,b){a=getLabel(a).toLowerCase();b=getLabel(b).toLowerCase();return(a>b?-1:(b>a?1:0));});}};var finders={store:function(q,callback){console.log("finding via store");callback(options.data);},ajax:function(q,callback){console.log("finding via ajax");var url=options.ajax+"?q="+encodeURI(q);for(var i in options.ajaxParams){url+="&"+i+"="+encodeURI(options.ajaxParams[i]);}
$.getJSON(url,callback);}};var moveSelect=function(step_or_li){var lis=$('li',results_list);if(!lis){return;}
if(typeof(step_or_li)==="number"){activeSelection=activeSelection+step_or_li;}
else{activeSelection=lis.index(step_or_li);}
if(activeSelection<0){activeSelection=0;}
else{if(activeSelection>=lis.size()){activeSelection=lis.size()-1;}}
console.log("Moved selection to "+activeSelection+".");lis.removeClass(options.selectedClass);$(lis[activeSelection]).addClass(options.selectedClass);if(options.autoFill&&this.last_keyCode!=8){$input_element.val(previous_value+$(lis[activeSelection]).text().substring(previous_value.length));var sel_start=previous_value.length;var sel_end=$input_element.val().length;var field=$input_element.get(0);if(field.createTextRange){var selRange=field.createTextRange();selRange.collapse(true);selRange.moveStart("character",sel_start);selRange.moveEnd("character",sel_end);selRange.select();}else if(field.setSelectionRange){field.setSelectionRange(sel_start,sel_end);}else if(field.selectionStart){field.selectionStart=sel_start;field.selectionEnd=sel_end;}
field.focus();}};var hideResultsNow=function(){console.log("Hiding results now");if(timeout){clearTimeout(timeout);}
$input_element.removeClass(options.loadingClass);if(results_list.is(":visible")){results_list.hide();}
if(results_mask.is(":visible")){results_mask.hide();}};var selectItem=function(li,from_hide_now_function){if(!li){li=document.createElement("li");li.item='';}
var label=getLabel(li.item);$input_element.lastSelected=label;$input_element.val(label);previous_value=label;results_list.empty();var values=getValues(li.item);options.additional_fields.each(function(i,input){input.value=values[i+1];});if(!from_hide_now_function){hideResultsNow();}
if(options.onItemSelect){setTimeout(function(){options.onItemSelect(li);},1);}
return true;};var selectCurrent=function(){var li=$("li."+options.selectedClass,results_list).get(0);if(li){return selectItem(li);}else{if(options.exactMatch){$input_element.val('');options.additional_fields.each(function(i,input){$(input).val('');});}
return false;}};var repopulate_items=function(items){console.log("Populating Items:");console.log(items);results_list.empty();var ul=document.createElement("ul");results_list.append(ul);if(!hasFocus||items===null||items.length===0){return hideResultsNow();}
var total_count=items.length;if(options.maxVisibleItems>0&&options.maxVisibleItems<total_count){total_count=options.maxVisibleItems;}
var hf=function(){moveSelect(this);};var bf=function(){};var cf=function(e){e.preventDefault();e.stopPropagation();selectItem(this);};for(var i=0;i<total_count;i++){var item=items[i];var li=document.createElement("li");results_list.append(li);$(li).text(options.formatItem?options.formatItem(item,i,total_count):getLabel(item));li.item=item;if(item.className){li.className=item.className;}
ul.appendChild(li);console.log(li);$(li).hover(hf,bf).click(cf);}
console.log("Added to list, no auto-fill, auto-select-first, or auto-select-single-match yet.");$input_element.removeClass(options.loadingClass);};var repopulate=function(q,callback){finders[!options.data?'ajax':'store'](q,function(data){repopulate_items(matchers[options.matchMethod](q,data));callback();});};var show_results=function(){var pos=$input_element.offset();var iWidth=(options.width>0)?options.width:$input_element.width();results_list.css({width:parseInt(iWidth,10)+"px",top:pos.top+$input_element.height()+5+"px",left:pos.left+"px"});if(ie_stupidity){results_mask.css({width:parseInt(iWidth,10)-2+"px",top:pos.top+$input_element.height()+6+"px",left:pos.left+1+"px",height:results_list.height()-2+'px'}).show();}
results_list.show();console.log("Showing list:");console.log(results_list);var $lis=$('li',results_list);if(options.autoSelectFirst||(options.selectSingleMatch&&$lis.length==1)){moveSelect($lis.get(0));}};var onChange=function(){console.log("changed! Running matching...");if(last_keyCode>=9&&last_keyCode<=45){return;}
var q=$input_element.val();if(q==previous_value){return;}
previous_value=q;if(q.length>=options.minChars){$input_element.addClass(options.loadingClass);repopulate(q,show_results);}else{if(q.length===0&&(options.onBlank?options.onBlank():true)){options.additional_fields.each(function(i,input){input.value='';});}
$input_element.removeClass(options.loadingClass);results_list.hide();results_mask.hide();}};results_list.mousedown(function(e){clickedLI=e.srcElement.tagName!='DIV';});$input_element.keydown(function(e){last_keyCode=e.keyCode;switch(e.keyCode){case 38:console.log("Select previous item");e.preventDefault();moveSelect(-1);break;case 40:console.log("Select next item");e.preventDefault();if(!results_list.is(":visible")){show_results();moveSelect(0);}else{moveSelect(1);}
break;case 13:console.log("Selecting current item and staying here");if(selectCurrent()){e.preventDefault();$input_element.select();}
break;case 9:console.log("Selecting current item and moving on");selectCurrent();break;case 27:console.log("Deselecting, hiding drop-down, staying in the field.");if(activeSelection>-1&&options.exactMatch&&$input_element.val()!=$('li',results_list).get(activeSelection).text()){activeSelection=-1;}
$('li',results_list).removeClass(options.selectedClass);hideResultsNow();e.preventDefault();break;default:console.log("reset timeout");if(timeout){clearTimeout(timeout);}
timeout=setTimeout(onChange,options.delay);break;}}).focus(function(){hasFocus=true;}).blur(function(e){if(clickedLI){if(activeSelection>-1){selectCurrent();}
hasFocus=false;if(timeout){clearTimeout(timeout);}
timeout=setTimeout(function(){hideResultsNow();if(options.exactMatch&&$input_element.val()!=$input_element.lastSelected){selectItem(null,true);}},200);}else{e.srcElement.focus();}});};$.fn.quickselect=function(options,data){options=options||{};options.data=(typeof(options.data)==="object"&&options.data.constructor==Array)?options.data:undefined;options.ajaxParams=options.ajaxParams||{};options.delay=options.delay||400;options.minChars=options.minChars||1;options.cssFlavor=options.cssFlavor||'quickselect';options.inputClass=options.inputClass||options.cssFlavor+"_input";options.loadingClass=options.loadingClass||options.cssFlavor+"_loading";options.resultsClass=options.resultsClass||options.cssFlavor+"_results";options.selectedClass=options.selectedClass||options.cssFlavor+"_selected";options.matchMethod=options.matchMethod||((typeof''.score==='function')&&'l'.score('l')==1?'quicksilver':'contains');if(options.matchCase===undefined){options.matchCase=false;}
if(options.exactMatch===undefined){options.exactMatch=false;}
if(options.autoSelectFirst===undefined){options.autoSelectFirst=true;}
if(options.selectSingleMatch===undefined){options.selectSingleMatch=true;}
options.maxVisibleItems=options.maxVisibleItems||-1;if(options.autoFill===undefined||options.matchMethod!='startsWith'){options.autoFill=false;}
options.width=parseInt(options.width,10)||0;this.each(function(){var input=this;var my_options=object(options);if(input.tagName=='INPUT'){QuickSelect(input,my_options);}else if(input.tagName=='SELECT'){my_options.delay=my_options.delay||10;var name=input.name;var id=input.id;var className=input.className;var accesskey=$(input).attr('accesskey');var tabindex=$(input).attr('tabindex');var selected_option=$("option:selected",input).get(0);my_options.data=[];$('option',input).each(function(i,option){console.log(option);my_options.data.push({label:$(option).text(),values:[option.value,option.value],className:option.className});});var text_input=$("<input type='text' class='"+className+"' id='"+id+"_quickselect' autocomplete='off' accesskey='"+accesskey+"' tabindex='"+tabindex+"' />");if(selected_option){text_input.val($(selected_option).text());}
var hidden_input=$("<input type='hidden' id='"+id+"' name='"+input.name+"' />");if(selected_option){hidden_input.val(selected_option.value);}
my_options.additional_fields=hidden_input;$(input).after(text_input).after(hidden_input).remove();text_input.quickselect(my_options);}});};})(jQuery);